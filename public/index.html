<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Config Editor & Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            min-height: calc(100vh - 200px);
        }

        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .config-textarea {
            flex: 1;
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            margin-bottom: 15px;
            min-height: 400px;
        }

        .config-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .templates {
            margin-bottom: 15px;
        }

        .templates select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
            display: block;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
            display: block;
        }

        .info-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            margin: 5px 0;
            font-size: 14px;
        }

        .search-controls {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .results-box {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .results-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .output-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #network-graph {
            width: 100%;
            height: 600px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .graph-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .graph-controls button {
            padding: 8px 16px;
            font-size: 12px;
        }

        .checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            cursor: pointer;
        }

        .legend {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
        }

        .legend h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #333;
        }

        .node-normal { background: #3b82f6; }
        .node-start { background: #10b981; }
        .node-visited { background: #f59e0b; }
        .node-found { background: #ef4444; }

        /* D3.js styles */
        .node circle {
            stroke: #333;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .node:hover circle {
            stroke-width: 3px;
            filter: brightness(1.2);
        }

        .node text {
            font-size: 12px;
            font-weight: bold;
            fill: white;
            pointer-events: none;
            user-select: none;
        }

        .resource-badge circle {
            cursor: pointer;
        }

        .resource-badge text {
            fill: white;
            font-size: 11px;
            font-weight: bold;
            pointer-events: none;
        }

        .resource-badge:hover circle {
            filter: brightness(1.2);
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .link-highlight {
            stroke: #ef4444;
            stroke-width: 4px;
            stroke-opacity: 0.8;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { stroke-opacity: 0.8; }
            50% { stroke-opacity: 0.3; }
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            #network-graph {
                height: 500px;
            }
        }

        .placeholder {
            color: #999;
            font-style: italic;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .comparison-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .comparison-table tr:hover {
            background: #f9fafb;
        }

        .comparison-table .best-value {
            background: #d1fae5;
            font-weight: bold;
            color: #065f46;
        }

        .comparison-table .worst-value {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .compare-summary {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .compare-summary h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .compare-summary p {
            margin: 5px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® P2P Network - Config Editor & Visualizer</h1>
            <p>Escreva sua configura√ß√£o JSON e visualize em tempo real</p>
        </header>

        <div class="main-grid">
            <!-- LEFT PANEL - INPUT -->
            <div class="panel input-section">
                <h2>üìù Configura√ß√£o da Rede</h2>

                <div class="templates">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block;">Templates:</label>
                    <select id="templateSelect">
                        <option value="">Selecione um template...</option>
                        <option value="small">Rede Pequena (5 n√≥s)</option>
                        <option value="medium">Rede M√©dia (12 n√≥s)</option>
                        <option value="large">Rede Grande (15 n√≥s - min 3, max 4)</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>

                <textarea
                    id="configInput"
                    class="config-textarea"
                    placeholder="Selecione um template acima OU digite/cole seu JSON aqui..."></textarea>

                <div class="button-group">
                    <button class="btn btn-primary" id="loadBtn">üöÄ Carregar e Visualizar</button>
                    <button class="btn btn-secondary" id="validateBtn">‚úì Validar JSON</button>
                    <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Limpar</button>
                </div>

                <div id="status" class="status"></div>

                <div class="info-box" id="networkInfo" style="display: none;">
                    <h3>üìä Informa√ß√µes da Rede</h3>
                    <div id="infoContent"></div>
                </div>

                <div class="search-controls">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üîç Buscar Recurso</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>N√≥ Inicial:</label>
                            <input type="text" id="startNode" placeholder="n1">
                        </div>
                        <div class="form-group">
                            <label>Recurso:</label>
                            <input type="text" id="resourceId" placeholder="r1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>TTL:</label>
                            <input type="number" id="ttl" value="10" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label>Algoritmo:</label>
                            <select id="algorithm">
                                <option value="flooding">Flooding</option>
                                <option value="informed_flooding">Informed Flooding</option>
                                <option value="random_walk">Random Walk</option>
                                <option value="informed_random_walk">Informed Random Walk</option>
                            </select>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" id="searchBtn">üîç Buscar</button>
                        <button class="btn btn-secondary" id="clearSearchBtn">Limpar Busca</button>
                    </div>
                </div>

                <div class="results-box" id="searchResults" style="display: none;">
                    <h3>üìà Resultados da Busca</h3>
                    <div id="resultsContent"></div>
                </div>

                <div class="search-controls">
                    <h3 style="color: #667eea; margin-bottom: 15px;">‚öñÔ∏è Comparar Algoritmos</h3>

                    <p style="font-size: 13px; margin-bottom: 15px; color: #666;">
                        Execute a mesma busca com todos os 4 algoritmos e compare os resultados
                    </p>

                    <div class="form-row">
                        <div class="form-group">
                            <label>N√≥ Inicial:</label>
                            <input type="text" id="compareStartNode" placeholder="n1">
                        </div>
                        <div class="form-group">
                            <label>Recurso:</label>
                            <input type="text" id="compareResourceId" placeholder="r1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>TTL:</label>
                        <input type="number" id="compareTtl" value="10" min="1" max="50">
                    </div>

                    <button class="btn btn-primary" id="compareBtn" style="width: 100%;">‚öñÔ∏è Comparar Todos os Algoritmos</button>
                </div>

                <div class="results-box" id="compareResults" style="display: none;">
                    <h3>üìä Compara√ß√£o de Algoritmos</h3>
                    <div id="compareContent"></div>
                </div>

                <div class="search-controls">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üéØ An√°lise de Caminhos Random Walk</h3>

                    <p style="font-size: 13px; margin-bottom: 15px; color: #666;">
                        Analise todos os caminhos poss√≠veis e calcule probabilidades
                    </p>

                    <div class="form-group">
                        <label>Dist√¢ncia Desejada (saltos):</label>
                        <input type="number" id="pathDistance" value="3" min="1" max="10">
                    </div>

                    <button class="btn btn-secondary" id="suggestPairsBtn" style="width: 100%;">üí° Sugerir Pares de N√≥s</button>

                    <div id="pairSuggestions" style="display: none; margin: 15px 0;">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Pares Sugeridos:</label>
                        <select id="pairSelect" size="5" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px;">
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>N√≥ Origem:</label>
                            <input type="text" id="pathOrigin" placeholder="n1">
                        </div>
                        <div class="form-group">
                            <label>N√≥ Destino:</label>
                            <input type="text" id="pathDestination" placeholder="n8">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>TTL M√°ximo:</label>
                        <input type="number" id="pathTtl" value="10" min="1" max="50">
                    </div>

                    <button class="btn btn-primary" id="analyzePathBtn" style="width: 100%;">üîç Analisar Caminhos</button>
                </div>

                <div class="results-box" id="pathResults" style="display: none;">
                    <h3>üìà An√°lise de Caminhos</h3>
                    <div id="pathContent"></div>
                </div>
            </div>

            <!-- RIGHT PANEL - OUTPUT -->
            <div class="panel output-section">
                <h2>üé® Visualiza√ß√£o da Rede</h2>

                <div class="graph-controls">
                    <button class="btn btn-secondary" id="resetZoom">Reset Zoom</button>
                    <button class="btn btn-secondary" id="centerGraph">Centralizar</button>
                    <button class="btn btn-success" id="exportBtn">üì∑ Exportar Topologia</button>
                    <label class="checkbox-label">
                        <input type="checkbox" id="showLabels" checked>
                        Mostrar Labels
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="showResourceCount" checked>
                        Mostrar Recursos
                    </label>
                </div>

                <svg id="network-graph"></svg>

                <div class="legend">
                    <h3>üé® Legenda</h3>
                    <div class="legend-item">
                        <span class="legend-circle node-normal"></span>
                        N√≥ Normal
                    </div>
                    <div class="legend-item">
                        <span class="legend-circle node-start"></span>
                        N√≥ Inicial
                    </div>
                    <div class="legend-item">
                        <span class="legend-circle node-visited"></span>
                        N√≥ Visitado
                    </div>
                    <div class="legend-item">
                        <span class="legend-circle node-found"></span>
                        Recurso Encontrado
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <div class="legend-item">
                            <span style="display: inline-block; width: 20px; height: 20px; border-radius: 50%; background: #ef4444; border: 2px solid white; text-align: center; line-height: 20px; color: white; font-size: 11px; font-weight: bold; margin-right: 8px;">3</span>
                            Badge = Qtd. Recursos
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/network-visualizer.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        let visualizer;
        let currentNetwork = null;

        // Templates
        const templates = {
            small: {
                num_nodes: 5,
                min_neighbors: 2,
                max_neighbors: 3,
                resources: {
                    n1: ["r1", "r2"],
                    n2: ["r3"],
                    n3: ["r4", "r5"],
                    n4: ["r6"],
                    n5: ["r7", "r8"]
                },
                edges: [
                    ["n1", "n2"],
                    ["n1", "n3"],
                    ["n2", "n3"],
                    ["n2", "n4"],
                    ["n3", "n5"],
                    ["n4", "n5"]
                ]
            },
            medium: {
                num_nodes: 12,
                min_neighbors: 2,
                max_neighbors: 4,
                resources: {
                    n1: ["r1", "r2", "r3"],
                    n2: ["r4", "r5"],
                    n3: ["r6", "r7", "r8"],
                    n4: ["r9"],
                    n5: ["r10", "r11"],
                    n6: ["r12", "r13", "r14"],
                    n7: ["r15"],
                    n8: ["r16", "r17"],
                    n9: ["r18", "r19", "r20"],
                    n10: ["r21"],
                    n11: ["r22", "r23"],
                    n12: ["r24", "r25", "r26"]
                },
                edges: [
                    ["n1", "n2"], ["n1", "n3"], ["n1", "n4"],
                    ["n2", "n4"], ["n2", "n5"], ["n3", "n6"],
                    ["n3", "n7"], ["n4", "n8"], ["n5", "n8"],
                    ["n5", "n9"], ["n6", "n10"], ["n7", "n10"],
                    ["n7", "n11"], ["n8", "n12"], ["n9", "n12"],
                    ["n10", "n11"], ["n11", "n12"]
                ]
            },
            large: {
                num_nodes: 15,
                min_neighbors: 3,
                max_neighbors: 4,
                resources: {
                    n1: ["r1"],
                    n2: ["r2"],
                    n3: ["r3"],
                    n4: ["r4"],
                    n5: ["r5"],
                    n6: ["r6"],
                    n7: ["r7"],
                    n8: ["r8"],
                    n9: ["r9"],
                    n10: ["r10"],
                    n11: ["r11"],
                    n12: ["r12"],
                    n13: ["r13"],
                    n14: ["r14"],
                    n15: ["r15"]
                },
                edges: [
                    ["n1", "n2"], ["n1", "n3"], ["n1", "n4"],
                    ["n2", "n5"], ["n2", "n6"], ["n2", "n7"],
                    ["n3", "n7"], ["n3", "n8"], ["n3", "n9"],
                    ["n4", "n9"], ["n4", "n10"], ["n4", "n11"],
                    ["n5", "n12"], ["n5", "n6"], ["n5", "n1"],
                    ["n6", "n12"], ["n6", "n13"],
                    ["n7", "n13"], ["n8", "n13"], ["n8", "n14"],
                    ["n9", "n14"], ["n10", "n14"], ["n10", "n15"],
                    ["n11", "n15"], ["n11", "n12"], ["n11", "n14"],
                    ["n12", "n15"], ["n13", "n15"]
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            visualizer = new NetworkVisualizer('#network-graph');
            initEventListeners();
        });

        function initEventListeners() {
            document.getElementById('templateSelect').addEventListener('change', handleTemplateSelect);
            document.getElementById('loadBtn').addEventListener('click', handleLoad);
            document.getElementById('validateBtn').addEventListener('click', handleValidate);
            document.getElementById('clearBtn').addEventListener('click', handleClear);
            document.getElementById('searchBtn').addEventListener('click', handleSearch);
            document.getElementById('clearSearchBtn').addEventListener('click', handleClearSearch);
            document.getElementById('compareBtn').addEventListener('click', handleCompare);
            document.getElementById('suggestPairsBtn').addEventListener('click', handleSuggestPairs);
            document.getElementById('analyzePathBtn').addEventListener('click', handleAnalyzePath);
            document.getElementById('pairSelect').addEventListener('change', handlePairSelect);
            document.getElementById('exportBtn').addEventListener('click', handleExport);
            document.getElementById('resetZoom').addEventListener('click', () => visualizer.resetZoom());
            document.getElementById('centerGraph').addEventListener('click', () => visualizer.centerGraph());
            document.getElementById('showLabels').addEventListener('change', (e) => visualizer.toggleLabels(e.target.checked));
        }

        function handleTemplateSelect(e) {
            const value = e.target.value;

            if (value === 'custom') {
                // Mostra exemplo edit√°vel para input personalizado
                const exampleConfig = {
                    num_nodes: 3,
                    min_neighbors: 1,
                    max_neighbors: 2,
                    resources: {
                        n1: ["r1", "r2"],
                        n2: ["r3"],
                        n3: ["r4"]
                    },
                    edges: [
                        ["n1", "n2"],
                        ["n2", "n3"],
                        ["n1", "n3"]
                    ]
                };

                document.getElementById('configInput').value = JSON.stringify(exampleConfig, null, 2);
                showStatus('üìù Exemplo carregado! Edite como quiser e clique em Carregar.', 'success');
                document.getElementById('configInput').focus();

                // Seleciona todo o texto para facilitar substitui√ß√£o
                document.getElementById('configInput').select();
            } else if (value === '') {
                // Op√ß√£o vazia selecionada - n√£o fazer nada
                return;
            } else {
                // Template selecionado
                const template = templates[value];
                if (template) {
                    document.getElementById('configInput').value = JSON.stringify(template, null, 2);
                    showStatus('‚úì Template carregado! Voc√™ pode editar antes de carregar.', 'success');
                }
            }
        }

        function handleValidate() {
            const input = document.getElementById('configInput').value.trim();
            if (!input) {
                showStatus('Digite uma configura√ß√£o JSON', 'error');
                return;
            }

            try {
                const config = JSON.parse(input);
                showStatus('‚úì JSON v√°lido!', 'success');
                return true;
            } catch (e) {
                showStatus('‚úó JSON inv√°lido: ' + e.message, 'error');
                return false;
            }
        }

        async function handleLoad() {
            const input = document.getElementById('configInput').value.trim();
            if (!input) {
                showStatus('Digite uma configura√ß√£o JSON', 'error');
                return;
            }

            let config;
            try {
                config = JSON.parse(input);
            } catch (e) {
                showStatus('‚úó JSON inv√°lido: ' + e.message, 'error');
                return;
            }

            try {
                showStatus('Carregando rede...', 'success');

                const response = await fetch(`${API_URL}/p2p/network/load`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.errors ? data.errors.join(', ') : data.message);
                }

                showStatus('‚úì Rede carregada e validada com sucesso!', 'success');
                displayNetworkInfo(data.info);
                await loadGraphData();
            } catch (error) {
                showStatus('‚úó Erro: ' + error.message, 'error');
                console.error('Load error:', error);
            }
        }

        async function loadGraphData() {
            try {
                const response = await fetch(`${API_URL}/p2p/network/graph`);
                const data = await response.json();

                currentNetwork = data;
                visualizer.render(data);

                setTimeout(() => {
                    visualizer.centerGraph();
                }, 100);
            } catch (error) {
                console.error('Graph load error:', error);
            }
        }

        function displayNetworkInfo(info) {
            const infoBox = document.getElementById('networkInfo');
            const content = document.getElementById('infoContent');

            content.innerHTML = `
                <p><strong>N√≥s:</strong> ${info.nodeCount}</p>
                <p><strong>Min Vizinhos:</strong> ${info.minNeighbors}</p>
                <p><strong>Max Vizinhos:</strong> ${info.maxNeighbors}</p>
                <p><strong>Total Recursos:</strong> ${info.totalResources}</p>
            `;

            infoBox.style.display = 'block';
        }

        async function handleSearch() {
            const startNode = document.getElementById('startNode').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const ttl = parseInt(document.getElementById('ttl').value);
            const algorithm = document.getElementById('algorithm').value;

            if (!startNode || !resourceId) {
                alert('Preencha o n√≥ inicial e o recurso');
                return;
            }

            if (!currentNetwork) {
                alert('Carregue uma rede primeiro');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/p2p/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        node_id: startNode,
                        resource_id: resourceId,
                        ttl: ttl,
                        algo: algorithm
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message);
                }

                displaySearchResults(data);
                visualizer.highlightSearch(data.result);
            } catch (error) {
                alert('Erro na busca: ' + error.message);
                console.error('Search error:', error);
            }
        }

        function displaySearchResults(data) {
            const resultsBox = document.getElementById('searchResults');
            const content = document.getElementById('resultsContent');
            const result = data.result;

            const algorithmNames = {
                'flooding': 'Flooding',
                'informed_flooding': 'Informed Flooding',
                'random_walk': 'Random Walk',
                'informed_random_walk': 'Informed Random Walk'
            };

            const foundText = result.found ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado';

            content.innerHTML = `
                <p><strong>Algoritmo:</strong> ${algorithmNames[data.algorithm]}</p>
                <p><strong>Status:</strong> ${foundText}</p>
                <p><strong>Recurso:</strong> ${result.resourceId}</p>
                ${result.found ? `<p><strong>Localiza√ß√£o:</strong> ${result.locationNodeId}</p>` : ''}
                <p><strong>Mensagens:</strong> ${result.totalMessages}</p>
                <p><strong>N√≥s Visitados:</strong> ${result.totalNodesVisited}</p>
                ${result.path.length > 0 ? `<p><strong>Caminho:</strong> ${result.path.join(' ‚Üí ')}</p>` : ''}
            `;

            resultsBox.style.display = 'block';
        }

        function handleClearSearch() {
            visualizer.resetHighlight();
            document.getElementById('searchResults').style.display = 'none';
        }

        async function handleCompare() {
            const startNode = document.getElementById('compareStartNode').value.trim();
            const resourceId = document.getElementById('compareResourceId').value.trim();
            const ttl = parseInt(document.getElementById('compareTtl').value);

            if (!startNode || !resourceId) {
                alert('Preencha o n√≥ inicial e o recurso');
                return;
            }

            if (!currentNetwork) {
                alert('Carregue uma rede primeiro');
                return;
            }

            const algorithms = ['flooding', 'informed_flooding', 'random_walk', 'informed_random_walk'];
            const results = [];

            try {
                // Executar busca com todos os algoritmos
                for (const algo of algorithms) {
                    const response = await fetch(`${API_URL}/p2p/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            node_id: startNode,
                            resource_id: resourceId,
                            ttl: ttl,
                            algo: algo
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || data.message);
                    }

                    results.push({
                        algorithm: algo,
                        ...data.result
                    });
                }

                displayComparisonResults(results, { startNode, resourceId, ttl });
            } catch (error) {
                alert('Erro na compara√ß√£o: ' + error.message);
                console.error('Compare error:', error);
            }
        }

        function displayComparisonResults(results, params) {
            const resultsBox = document.getElementById('compareResults');
            const content = document.getElementById('compareContent');

            const algorithmNames = {
                'flooding': 'Flooding',
                'informed_flooding': 'Informed Flooding',
                'random_walk': 'Random Walk',
                'informed_random_walk': 'Informed Random Walk'
            };

            // Encontrar melhor e pior para cada m√©trica (entre os que encontraram)
            const foundResults = results.filter(r => r.found);
            let bestMessages = foundResults.length > 0 ? Math.min(...foundResults.map(r => r.totalMessages)) : null;
            let worstMessages = foundResults.length > 0 ? Math.max(...foundResults.map(r => r.totalMessages)) : null;
            let bestNodes = foundResults.length > 0 ? Math.min(...foundResults.map(r => r.totalNodesVisited)) : null;
            let worstNodes = foundResults.length > 0 ? Math.max(...foundResults.map(r => r.totalNodesVisited)) : null;

            // Criar tabela HTML
            let tableHTML = `
                <div class="compare-summary">
                    <h4>üìã Par√¢metros da Busca</h4>
                    <p><strong>N√≥ Inicial:</strong> ${params.startNode}</p>
                    <p><strong>Recurso:</strong> ${params.resourceId}</p>
                    <p><strong>TTL:</strong> ${params.ttl}</p>
                </div>

                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Algoritmo</th>
                            <th>Status</th>
                            <th>Localiza√ß√£o</th>
                            <th>Mensagens</th>
                            <th>N√≥s Visitados</th>
                            <th>Caminho</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(result => {
                const statusBadge = result.found
                    ? '<span class="status-badge badge-success">‚úÖ Encontrado</span>'
                    : '<span class="status-badge badge-error">‚ùå N√£o encontrado</span>';

                const location = result.found ? result.locationNodeId : 'N/A';
                const path = result.path && result.path.length > 0 ? result.path.join(' ‚Üí ') : 'N/A';

                // Destacar melhor e pior valores
                const messagesClass = result.found
                    ? (result.totalMessages === bestMessages ? 'best-value' :
                       result.totalMessages === worstMessages ? 'worst-value' : '')
                    : '';

                const nodesClass = result.found
                    ? (result.totalNodesVisited === bestNodes ? 'best-value' :
                       result.totalNodesVisited === worstNodes ? 'worst-value' : '')
                    : '';

                tableHTML += `
                    <tr>
                        <td><strong>${algorithmNames[result.algorithm]}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${location}</td>
                        <td class="${messagesClass}">${result.totalMessages}</td>
                        <td class="${nodesClass}">${result.totalNodesVisited}</td>
                        <td style="font-size: 11px;">${path}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            // Adicionar an√°lise
            const successCount = results.filter(r => r.found).length;
            tableHTML += `
                <div class="compare-summary" style="margin-top: 15px;">
                    <h4>üìä An√°lise</h4>
                    <p><strong>Taxa de Sucesso:</strong> ${successCount}/4 algoritmos encontraram o recurso</p>
            `;

            if (successCount > 0) {
                const bestMsgAlgo = foundResults.find(r => r.totalMessages === bestMessages);
                const bestNodesAlgo = foundResults.find(r => r.totalNodesVisited === bestNodes);

                tableHTML += `
                    <p><strong>Mais Eficiente (Mensagens):</strong> ${algorithmNames[bestMsgAlgo.algorithm]} (${bestMessages} mensagens)</p>
                    <p><strong>Mais Eficiente (N√≥s):</strong> ${algorithmNames[bestNodesAlgo.algorithm]} (${bestNodes} n√≥s)</p>
                `;
            }

            tableHTML += `
                </div>
            `;

            content.innerHTML = tableHTML;
            resultsBox.style.display = 'block';

            // Scroll para ver os resultados
            resultsBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function handleClear() {
            document.getElementById('configInput').value = '';
            document.getElementById('status').className = 'status';
            document.getElementById('networkInfo').style.display = 'none';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('compareResults').style.display = 'none';
            document.getElementById('pathResults').style.display = 'none';
            visualizer.render({ nodes: [], links: [] });
            currentNetwork = null;
        }

        async function handleSuggestPairs() {
            if (!currentNetwork) {
                alert('Carregue uma rede primeiro');
                return;
            }

            const distance = parseInt(document.getElementById('pathDistance').value);

            try {
                const response = await fetch(`${API_URL}/p2p/path/suggest?distance=${distance}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao sugerir pares');
                }

                const select = document.getElementById('pairSelect');
                select.innerHTML = '';

                if (data.pairs.length === 0) {
                    select.innerHTML = '<option>Nenhum par encontrado com essa dist√¢ncia</option>';
                } else {
                    data.pairs.forEach(pair => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(pair);
                        option.textContent = `${pair.origin} ‚Üí ${pair.destination} (${pair.distance} saltos)`;
                        select.appendChild(option);
                    });
                }

                document.getElementById('pairSuggestions').style.display = 'block';
                showStatus(`‚úì Encontrados ${data.total} pares com ${distance} saltos`, 'success');
            } catch (error) {
                alert('Erro ao sugerir pares: ' + error.message);
                console.error('Suggest pairs error:', error);
            }
        }

        function handlePairSelect(e) {
            if (!e.target.value) return;

            try {
                const pair = JSON.parse(e.target.value);
                document.getElementById('pathOrigin').value = pair.origin;
                document.getElementById('pathDestination').value = pair.destination;
            } catch (error) {
                console.error('Parse pair error:', error);
            }
        }

        async function handleAnalyzePath() {
            if (!currentNetwork) {
                alert('Carregue uma rede primeiro');
                return;
            }

            const origin = document.getElementById('pathOrigin').value.trim();
            const destination = document.getElementById('pathDestination').value.trim();
            const ttl = parseInt(document.getElementById('pathTtl').value);

            if (!origin || !destination) {
                alert('Preencha origem e destino');
                return;
            }

            try {
                const response = await fetch(
                    `${API_URL}/p2p/path/analyze?origin=${origin}&destination=${destination}&ttl=${ttl}`
                );
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erro na an√°lise');
                }

                displayPathAnalysis(data);
            } catch (error) {
                alert('Erro na an√°lise: ' + error.message);
                console.error('Analyze path error:', error);
            }
        }

        function displayPathAnalysis(data) {
            const resultsBox = document.getElementById('pathResults');
            const content = document.getElementById('pathContent');

            let html = `
                <div class="compare-summary">
                    <h4>üìã Informa√ß√µes Gerais</h4>
                    <p><strong>Origem:</strong> ${data.origin}</p>
                    <p><strong>Destino:</strong> ${data.destination}</p>
                    <p><strong>Menor Dist√¢ncia:</strong> ${data.shortestDistance} saltos</p>
                    <p><strong>Caminhos Poss√≠veis:</strong> ${data.totalPaths}</p>
                </div>

                <div class="compare-summary" style="background: #d1fae5; border-color: #10b981;">
                    <h4>‚úÖ Melhor Caso (Caminho Mais Curto)</h4>
                    <p><strong>Caminho:</strong> ${data.bestCase.path.join(' ‚Üí ')}</p>
                    <p><strong>Comprimento:</strong> ${data.bestCase.length} saltos</p>
                    <p><strong>Probabilidade:</strong> ${(data.bestCase.probability * 100).toFixed(2)}% (${data.bestCase.probability.toFixed(4)})</p>
                </div>

                <div class="compare-summary" style="background: #fee2e2; border-color: #ef4444;">
                    <h4>‚ùå Pior Caso (Caminho Mais Longo)</h4>
                    <p><strong>Caminho:</strong> ${data.worstCase.path.join(' ‚Üí ')}</p>
                    <p><strong>Comprimento:</strong> ${data.worstCase.length} saltos</p>
                    <p><strong>Probabilidade:</strong> ${(data.worstCase.probability * 100).toFixed(2)}% (${data.worstCase.probability.toFixed(4)})</p>
                </div>

                <h4 style="margin: 15px 0 10px 0;">üìã Todos os Caminhos Poss√≠veis</h4>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Caminho</th>
                            <th>Saltos</th>
                            <th>Probabilidade</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.allPaths.forEach((path, index) => {
                const isBest = path.length === data.bestCase.length && path.path.join(',') === data.bestCase.path.join(',');
                const isWorst = path.length === data.worstCase.length && path.path.join(',') === data.worstCase.path.join(',');
                const rowClass = isBest ? 'best-value' : (isWorst ? 'worst-value' : '');

                html += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td style="font-size: 11px;">${path.path.join(' ‚Üí ')}</td>
                        <td>${path.length}</td>
                        <td>${path.probability.toFixed(4)}</td>
                        <td>${(path.probability * 100).toFixed(2)}%</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            content.innerHTML = html;
            resultsBox.style.display = 'block';
            resultsBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function handleExport() {
            const svg = document.getElementById('network-graph');
            const svgData = new XMLSerializer().serializeToString(svg);

            // Create canvas
            const canvas = document.createElement('canvas');
            const bbox = svg.getBBox();
            canvas.width = bbox.width + 100;
            canvas.height = bbox.height + 100;
            const ctx = canvas.getContext('2d');

            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Create image from SVG
            const img = new Image();
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                ctx.drawImage(img, 50, 50);
                URL.revokeObjectURL(url);

                // Download
                canvas.toBlob(function(blob) {
                    const link = document.createElement('a');
                    link.download = `topologia-p2p-${new Date().getTime()}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);

                    showStatus('‚úì Topologia exportada com sucesso!', 'success');
                });
            };

            img.src = url;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;

            if (type === 'success') {
                setTimeout(() => {
                    status.className = 'status';
                }, 5000);
            }
        }
    </script>
</body>
</html>
